<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Indoor Radar IPS Simulation</title>
  <style>
    body { margin: 0; overflow: hidden; background: #20232a; }
    #info { position: absolute; top: 10px; left: 10px; color: #fff; font-family: sans-serif; }
    #svg-file-label {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 10;
      background: rgba(32,35,42,0.85);
      color: #fff;
      border-radius: 6px;
      padding: 6px 10px;
      font-family: sans-serif;
      border: 1px solid #444;
      cursor: pointer;
      display: inline-block;
    }
    #svg-file-label input[type="file"] {
      display: none;
    }
  </style>
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.152.2/build/three.module.js",
      "three/": "https://unpkg.com/three@0.152.2/"
    }
  }
  </script>
  <script type="module" src="main.obf.js"></script>
</head>
<body style="margin:0;overflow:hidden;background:#20232a;">
  <div id="help-container" style="position:absolute;top:10px;left:50%;transform:translateX(-50%);z-index:15;text-align:center;min-width:120px;">
    <button id="help-btn" style="background:#282c34;color:#fff;border:none;border-radius:6px;padding:8px 24px;font-family:sans-serif;font-size:1em;box-shadow:0 2px 8px #0003;cursor:pointer;">Help</button>
    <div id="help-warning" style="color:#ffb300;font-family:sans-serif;font-size:0.95em;margin-top:4px;display:none;"></div>
  </div>
  <label id="svg-file-label" for="svg-file-selector" style="position:absolute;top:10px;right:10px;z-index:10;background:rgba(32,35,42,0.85);padding:8px 14px 8px 8px;border-radius:6px;box-shadow:0 2px 8px #0003;font-family:sans-serif;color:#fff;font-size:1em;cursor:pointer;">
    <span style="padding-right:8px;">Select Path</span>
    <input id="svg-file-selector" type="file" accept=".svg" title="Select SVG file" />
  </label>
  <div id="svg-file-name" style="position:absolute;top:44px;right:10px;z-index:10;color:#fff;font-family:sans-serif;font-size:0.95em;"></div>
  <label id="follow-path-label" style="position:absolute;top:68px;right:10px;z-index:10;color:#fff;font-family:sans-serif;font-size:0.95em;background:rgba(32,35,42,0.85);padding:4px 10px 4px 4px;border-radius:6px;display:flex;align-items:center;gap:6px;">
    <input type="checkbox" id="follow-path-checkbox" style="margin:0;" />
    Follow Path
  </label>
  <div id="sample-interval-container" style="position:absolute;top:98px;right:10px;z-index:10;color:#fff;font-family:sans-serif;font-size:0.95em;background:rgba(32,35,42,0.85);padding:4px 10px 8px 10px;border-radius:6px;min-width:180px;">
    <label for="sample-interval-slider" style="display:block;margin-bottom:2px;">Position Sample Interval (ms)</label>
    <input type="range" id="sample-interval-slider" min="1" max="100" value="10" style="width:100%;">
    <span id="sample-interval-value" style="display:inline-block;width:32px;text-align:right;margin-top:2px;">10</span>
    <div style="height:10px;"></div>
    <label for="target-speed-slider" style="display:block;margin-bottom:2px;">Target Speed (mm/s)</label>
    <input type="range" id="target-speed-slider" min="1" max="2000" value="500" style="width:100%;">
    <span id="target-speed-value" style="display:inline-block;width:48px;text-align:right;margin-top:2px;">500</span>
  </div>
  <div id="info">Use arrow keys to move the device.</div>
  <script>
  document.getElementById('svg-file-selector').addEventListener('change', function(e) {
    const fileDiv = document.getElementById('svg-file-name');
    if (this.files && this.files.length > 0) {
      fileDiv.textContent = this.files[0].name;
    } else {
      fileDiv.textContent = '';
    }
  });
  // Update displayed value for sample interval slider
  const slider = document.getElementById('sample-interval-slider');
  const sliderValue = document.getElementById('sample-interval-value');
  slider.addEventListener('input', function() {
    sliderValue.textContent = this.value;
  });
  // Update displayed value for target speed slider
  const speedSlider = document.getElementById('target-speed-slider');
  const speedValue = document.getElementById('target-speed-value');
  speedSlider.addEventListener('input', function() {
    speedValue.textContent = this.value;
  });

  // Help button logic
  document.getElementById('help-btn').addEventListener('click', function() {
    const helpHtml = `
      <html><head><title>Help</title><style>
      body { background: #20232a; color: #fff; font-family: sans-serif; margin: 0; padding: 18px; }
      h2 { color: #00ffff; }
      ul { margin: 0 0 18px 0; padding-left: 20px; }
      .color-box { display:inline-block; width:16px; height:16px; border-radius:3px; margin-right:6px; vertical-align:middle; }
      </style></head><body>
      <h2>Legend</h2>
      <ul>
        <li><span class='color-box' style='background:#ff0000;'></span>Anchors (red)</li>
        <li><span class='color-box' style='background:#e75480;'></span>Mobile Device (rose)</li>
        <li><span class='color-box' style='background:#00ffff;'></span>Anchor Range Detection (cyan lines)</li>
        <li><span class='color-box' style='background:#00ff00;'></span>SVG Path Overlay</li>
        <li><span class='color-box' style='background:#fff;'></span>Ground Grid</li>
      </ul>
      <h2>Keyboard Controls</h2>
      <ul>
        <li><b>Arrow Keys</b>: Move device in the X/Y plane</li>
        <li><b>Ctrl + Up/Down</b>: Move device height (Z axis, up/down from human perspective)</li>
        <li><b>Home</b>: Reset device to origin</li>
      </ul>
      <h2>Mouse / Pointer</h2>
      <ul>
        <li><b>Left-drag</b>: Orbit camera</li>
        <li><b>Right-drag</b>: Pan camera</li>
        <li><b>Scroll</b>: Zoom in/out</li>
      </ul>
      <p>Note: In this simulation, X and Y are the ground plane axes. Z is height (vertical), matching the human perspective viewing the scene.<br>
      Use the controls at the top right to select an SVG path, toggle path following, and adjust simulation parameters.</p>
      </body></html>
    `;
    let win;
    try {
      win = window.open('', 'Help', 'width=410,height=420');
      if (!win) throw new Error('Popup blocked');
      win.document.write(helpHtml);
      win.document.close();
    } catch (err) {
      const warn = document.getElementById('help-warning');
      warn.textContent = 'Unable to open help window: ' + err.message;
      warn.style.display = 'block';
      setTimeout(() => { warn.style.display = 'none'; }, 5000);
    }
  });

  window.addEventListener('error', event => {
    const info = document.getElementById('info');
    info.style.color = 'red';
    info.textContent = 'Error: ' + event.message;
  });
  window.addEventListener('unhandledrejection', event => {
    const info = document.getElementById('info');
    info.style.color = 'red';
    info.textContent = 'Promise Error: ' + event.reason;
  });
  </script>
</body>
</html>
